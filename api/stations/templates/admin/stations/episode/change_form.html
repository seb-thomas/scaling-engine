{% extends "admin/change_form.html" %}
{% load i18n admin_urls %}

{% block submit_buttons_bottom %}
{{ block.super }}
{% if show_reprocess_button and original %}
<div class="submit-row">
    <a href="{% url 'admin:stations_episode_reprocess' original.pk %}"
       class="button default"
       style="background-color: #417690; color: white; padding: 10px 15px; text-decoration: none; border-radius: 4px; margin-left: 10px;">
        Reprocess with AI
    </a>
    <p style="margin-top: 10px; color: #666; font-size: 12px;">
        Re-run book extraction on this episode. Replaces any existing books.
    </p>
</div>
{% endif %}
{% endblock %}

{% block extrahead %}
{{ block.super }}
{% if awaiting_reprocess %}
<script>
(function() {
    var statusUrl = "{{ status_url }}";
    var interval = setInterval(function() {
        fetch(statusUrl)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.status === "PROCESSED" || data.status === "FAILED") {
                    clearInterval(interval);
                    // Reload without the query param so we don't keep polling
                    window.location.href = window.location.pathname;
                }
            })
            .catch(function() {});
    }, 2000);
})();
</script>
{% endif %}
{% endblock %}
