{% extends "admin/base_site.html" %}
{% load i18n %}

{% block title %}System Health{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Home</a>
    &rsaquo; System Health
</div>
{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
    .health-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 24px; }
    .health-card { background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 14px; text-align: center; }
    .health-card .dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; margin-bottom: 6px; }
    .dot-ok { background: #28a745; }
    .dot-warning { background: #ffc107; }
    .dot-error { background: #dc3545; }
    .health-card .label { font-size: 12px; color: #666; display: block; }
    .health-card .detail { font-size: 11px; color: #999; margin-top: 4px; }

    .stats-row { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 24px; }
    .stat-box { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; padding: 12px 18px; min-width: 120px; }
    .stat-box .number { font-size: 28px; font-weight: bold; color: #212529; }
    .stat-box .label { font-size: 12px; color: #666; }

    .section { margin-bottom: 28px; }
    .section h3 { margin: 0 0 12px 0; font-size: 16px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 6px; }

    table.health-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    table.health-table th { text-align: left; padding: 8px 10px; background: #f8f9fa; border-bottom: 2px solid #dee2e6; font-size: 12px; color: #666; text-transform: uppercase; }
    table.health-table td { padding: 8px 10px; border-bottom: 1px solid #eee; }
    table.health-table tr:hover { background: #f8f9fa; }

    .actions-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 24px; }
    .actions-row form { display: inline; }
    .btn { display: inline-block; padding: 8px 16px; border-radius: 4px; text-decoration: none; font-size: 13px; cursor: pointer; border: 1px solid #ccc; background: #fff; color: #333; }
    .btn:hover { background: #f0f0f0; }
    .btn-warning { border-color: #ffc107; background: #fff3cd; color: #664d03; }
    .btn-warning:hover { background: #ffecb5; }
    .btn-primary { border-color: #0d6efd; background: #e7f1ff; color: #0a58ca; }
    .btn-primary:hover { background: #cfe2ff; }

    .badge { display: inline-block; padding: 2px 8px; border-radius: 3px; font-size: 11px; font-weight: bold; }
    .badge-ok { background: #d4edda; color: #155724; }
    .badge-warning { background: #fff3cd; color: #664d03; }
    .badge-error { background: #f8d7da; color: #721c24; }

    .error-text { color: #dc3545; font-size: 12px; }
    .muted { color: #999; }
    .mono { font-family: monospace; font-size: 12px; }

    .overall-banner { padding: 10px 16px; border-radius: 6px; margin-bottom: 20px; font-weight: bold; font-size: 15px; }
    .overall-healthy { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .overall-degraded { background: #fff3cd; color: #664d03; border: 1px solid #ffeeba; }
    .overall-unhealthy { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
</style>
{% endblock %}

{% block content %}
<div style="max-width: 900px;">

    <!-- Overall status banner -->
    <div class="overall-banner overall-{{ health.status|default:'unhealthy' }}">
        {% if health.status == "healthy" %}
            All systems operational
        {% elif health.status == "degraded" %}
            System degraded — some checks need attention
        {% else %}
            System unhealthy — immediate attention needed
        {% endif %}
    </div>

    <!-- Status cards -->
    <div class="health-grid">
        {% for name, check in health.checks.items %}
        <div class="health-card">
            <div class="dot dot-{{ check.status }}"></div>
            <span class="label">{{ name|cut:"_" }}</span>
            {% if check.message %}
            <div class="detail">{{ check.message }}</div>
            {% elif check.latency_ms != None %}
            <div class="detail">{{ check.latency_ms }}ms</div>
            {% elif check.workers != None %}
            <div class="detail">{{ check.workers }} worker{{ check.workers|pluralize }}</div>
            {% elif check.days_left != None %}
            <div class="detail">{{ check.days_left }} days</div>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- Pipeline stats -->
    <div class="section">
        <h3>Pipeline</h3>
        <div class="stats-row">
            <div class="stat-box">
                <div class="number">{{ health.pipeline.awaiting_processing|default:"0" }}</div>
                <div class="label">Awaiting</div>
            </div>
            <div class="stat-box">
                <div class="number">{{ health.pipeline.queued|default:"0" }}</div>
                <div class="label">Queued</div>
            </div>
            <div class="stat-box">
                <div class="number">{{ health.pipeline.processing|default:"0" }}</div>
                <div class="label">Processing</div>
            </div>
            <div class="stat-box">
                <div class="number">{{ health.pipeline.processed_24h|default:"0" }}</div>
                <div class="label">Processed (24h)</div>
            </div>
            <div class="stat-box">
                <div class="number">{{ health.pipeline.failed_24h|default:"0" }}</div>
                <div class="label">Failed (24h)</div>
            </div>
            <div class="stat-box">
                <div class="number">{{ health.pipeline.stuck_count|default:"0" }}</div>
                <div class="label">Stuck</div>
            </div>
            <div class="stat-box">
                <div class="number">{{ health.pipeline.total_episodes|default:"0" }}</div>
                <div class="label">Total episodes</div>
            </div>
        </div>

        {% if health.pipeline.newest_episode %}
        <p style="font-size: 13px; color: #666; margin: 4px 0;">
            <strong>Newest episode:</strong> {{ health.pipeline.newest_episode.title }}
            {% if health.pipeline.newest_episode.aired_at %}({{ health.pipeline.newest_episode.aired_at }}){% endif %}
        </p>
        {% endif %}
        {% if health.pipeline.last_processed %}
        <p style="font-size: 13px; color: #666; margin: 4px 0;">
            <strong>Last processed:</strong> {{ health.pipeline.last_processed.title }}
            {% if health.pipeline.last_processed.processed_at %}({{ health.pipeline.last_processed.processed_at }}){% endif %}
        </p>
        {% endif %}
    </div>

    <!-- Beat schedule -->
    {% if health.checks.beat_schedule.tasks %}
    <div class="section">
        <h3>Beat Schedule</h3>
        <table class="health-table">
            <thead>
                <tr>
                    <th>Task</th>
                    <th>Status</th>
                    <th>Last Run</th>
                    <th>Run Count</th>
                </tr>
            </thead>
            <tbody>
                {% for task in health.checks.beat_schedule.tasks %}
                <tr>
                    <td class="mono">{{ task.name }}</td>
                    <td><span class="badge badge-{{ task.status }}">{{ task.status }}</span></td>
                    <td>
                        {% if task.last_run_at %}
                            {{ task.last_run_at }}
                            {% if task.age_minutes != None %}
                                <span class="muted">({{ task.age_minutes }}min ago)</span>
                            {% endif %}
                        {% else %}
                            <span class="muted">Never</span>
                        {% endif %}
                    </td>
                    <td>{{ task.total_run_count|default:"-" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Actions -->
    <div class="section">
        <h3>Actions</h3>
        <div class="actions-row">
            {% if health.pipeline.stuck_count > 0 %}
            <form method="post" action="{% url 'admin:stations_health_unstick' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-warning"
                        onclick="return confirm('Reset {{ health.pipeline.stuck_count }} stuck episode(s) back to SCRAPED?')">
                    Unstick {{ health.pipeline.stuck_count }} episode{{ health.pipeline.stuck_count|pluralize }}
                </button>
            </form>
            {% endif %}
            <form method="post" action="{% url 'admin:stations_health_run_extraction' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary">Run Extraction Now</button>
            </form>
            <form method="post" action="{% url 'admin:stations_health_run_scrape' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary">Run Scrape Now</button>
            </form>
            <a href="http://{{ request.META.HTTP_HOST|cut:':80'|cut:':443' }}:5555" target="_blank" class="btn">
                Open Flower
            </a>
        </div>
    </div>

    <!-- Stuck episodes -->
    {% if health.pipeline.stuck_episodes %}
    <div class="section">
        <h3>Stuck Episodes</h3>
        <table class="health-table">
            <thead>
                <tr><th>ID</th><th>Title</th><th>Status</th><th>Since</th></tr>
            </thead>
            <tbody>
                {% for ep in health.pipeline.stuck_episodes %}
                <tr>
                    <td><a href="{% url 'admin:stations_episode_change' ep.id %}">{{ ep.id }}</a></td>
                    <td>{{ ep.title }}</td>
                    <td>{{ ep.status }}</td>
                    <td class="mono">{{ ep.status_changed_at }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Recent failures -->
    {% if health.pipeline.recent_failures %}
    <div class="section">
        <h3>Recent Failures</h3>
        <table class="health-table">
            <thead>
                <tr><th>ID</th><th>Title</th><th>Error</th><th>When</th></tr>
            </thead>
            <tbody>
                {% for f in health.pipeline.recent_failures %}
                <tr>
                    <td><a href="{% url 'admin:stations_episode_change' f.id %}">{{ f.id }}</a></td>
                    <td>{{ f.title }}</td>
                    <td class="error-text">{{ f.error }}</td>
                    <td class="mono">{{ f.failed_at }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <p class="muted" style="font-size: 11px; margin-top: 24px;">
        Last checked: {{ health.timestamp }} &middot; Auto-refreshes every 60s &middot; Data cached 30s
    </p>
</div>

<script>
    setTimeout(function() { location.reload(); }, 60000);
</script>
{% endblock %}
