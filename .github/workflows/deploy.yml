name: Deploy to Digital Ocean

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Python dependencies
        working-directory: ./api
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Wait for database
        run: |
          until pg_isready -h localhost -p 5432 -U postgres; do
            echo "Waiting for database..."
            sleep 2
          done

      - name: Run backend tests
        working-directory: ./api
        env:
          SECRET_KEY: test-secret-key-for-ci-only-min-50-chars-long
          DEBUG: 1
          DJANGO_ALLOWED_HOSTS: localhost
          SQL_ENGINE: django.db.backends.postgresql
          SQL_DATABASE: test_db
          SQL_USER: postgres
          SQL_PASSWORD: postgres
          SQL_HOST: localhost
          SQL_PORT: 5432
          CELERY_BROKER_URL: redis://localhost:6379/0
          CELERY_RESULT_BACKEND: redis://localhost:6379
          DJANGO_SETTINGS_MODULE: paperwaves.settings
        run: |
          python manage.py check
          python manage.py migrate
          pytest -v --tb=short -x

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run frontend tests
        working-directory: ./frontend
        run: npm run test:run

  deploy:
    name: Deploy to Digital Ocean
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        timeout-minutes: 15
        env:
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          SQL_PASSWORD: ${{ secrets.SQL_PASSWORD }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          script_stop: true
          debug: true
          script: |
            set -e  # Exit on any error
            set -x  # Print commands as they execute
            
            # Determine docker-compose command (support both old and new syntax)
            if command -v docker-compose &> /dev/null; then
              DOCKER_COMPOSE="docker-compose"
            elif docker compose version &> /dev/null; then
              DOCKER_COMPOSE="docker compose"
            else
              echo "❌ Error: docker-compose not found!"
              exit 1
            fi
            echo "Using: $DOCKER_COMPOSE"
            
            # Navigate to project directory
            cd ~/scaling-engine || cd /root/scaling-engine || { echo "❌ Error: Could not find project directory"; exit 1; }
            pwd
            ls -la
            
            echo "Pulling latest code..."
            git pull origin master || { echo "❌ Error: git pull failed"; exit 1; }
            
            # Generate .env.prod from secrets and template
            {
              echo "# Django Settings"
              echo "DEBUG=1"
              echo "SECRET_KEY=${SECRET_KEY}"
              echo "DJANGO_ALLOWED_HOSTS=159.65.18.16,209.38.161.55,web,localhost,radioreads.fun,www.radioreads.fun"
              echo ""
              echo "# Database Settings"
              echo "SQL_ENGINE=django.db.backends.postgresql"
              echo "SQL_DATABASE=paperwaves_prod"
              echo "SQL_USER=paperwaves_user"
              echo "SQL_PASSWORD=${SQL_PASSWORD}"
              echo "SQL_HOST=db"
              echo "SQL_PORT=5432"
              echo ""
              echo "# Celery Settings"
              echo "CELERY_BROKER_URL=redis://redis:6379/0"
              echo "CELERY_RESULT_BACKEND=redis://redis:6379"
              echo ""
              echo "# AI / Book Extraction"
              echo "# Options: 'keyword' (legacy), 'ai' (Claude), 'both' (run both methods)"
              echo "BOOK_EXTRACTION_MODE=ai"
            } > .env.prod
            
            # Add ANTHROPIC_API_KEY if provided
            if [ -n "${ANTHROPIC_API_KEY}" ]; then
              echo "ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}" >> .env.prod
            fi
            
            # Generate .env.prod.db
            {
              echo "# PostgreSQL Database Configuration"
              echo "POSTGRES_USER=paperwaves_user"
              echo "POSTGRES_PASSWORD=${SQL_PASSWORD}"
              echo "POSTGRES_DB=paperwaves_prod"
            } > .env.prod.db
            
            # Verify .env files were created
            if [ ! -f .env.prod ] || [ ! -f .env.prod.db ]; then
              echo "❌ Error: .env files were not created!"
              ls -la .env* || echo "No .env files found"
              exit 1
            fi
            
            # Validate required environment variables
            if [ -z "${SECRET_KEY}" ]; then
              echo "❌ Error: SECRET_KEY is not set!"
              exit 1
            fi
            if [ -z "${SQL_PASSWORD}" ]; then
              echo "❌ Error: SQL_PASSWORD is not set!"
              exit 1
            fi
            
            echo "✅ .env files created and validated"
            
            # Health check functions
            wait_for_service() {
              local compose_file=$1
              local service=$2
              local max_attempts=30
              local attempt=1
              while [ $attempt -le $max_attempts ]; do
                if $DOCKER_COMPOSE -f "$compose_file" ps | grep -q "$service.*Up"; then
                  echo "✅ $service is up"
                  return 0
                fi
                echo "Waiting for $service... ($attempt/$max_attempts)"
                sleep 2
                attempt=$((attempt + 1))
              done
              echo "❌ $service failed to start"
              return 1
            }
            
            verify_frontend() {
              local max_attempts=10
              local attempt=1
              while [ $attempt -le $max_attempts ]; do
                response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/ || echo "000")
                if [ "$response" = "200" ]; then
                  # Check for React content (not Django template)
                  content=$(curl -s http://localhost:3000/ | grep -o '<div id="root">' || echo "")
                  if [ -n "$content" ]; then
                    echo "✅ Frontend is serving React"
                    return 0
                  fi
                fi
                echo "Waiting for frontend to be ready... ($attempt/$max_attempts)"
                sleep 3
                attempt=$((attempt + 1))
              done
              echo "❌ Frontend verification failed"
              return 1
            }
            
            verify_api() {
              local max_attempts=10
              local attempt=1
              while [ $attempt -le $max_attempts ]; do
                response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/api/stations/ || echo "000")
                if [ "$response" = "200" ]; then
                  echo "✅ API is responding"
                  return 0
                fi
                echo "Waiting for API to be ready... ($attempt/$max_attempts)"
                sleep 3
                attempt=$((attempt + 1))
              done
              echo "❌ API verification failed"
              return 1
            }
            
            # Build and deploy
            # Use docker-compose.react.yml if it exists (includes frontend), otherwise use docker-compose.prod.yml
            if [ -f docker-compose.react.yml ]; then
              # Clean restart to prevent container state issues
              echo "Stopping existing containers..."
              $DOCKER_COMPOSE -f docker-compose.react.yml down || echo "No containers to stop"
              
              echo "Building containers..."
              $DOCKER_COMPOSE -f docker-compose.react.yml build || { echo "❌ Build failed"; exit 1; }
              
              echo "Starting containers..."
              $DOCKER_COMPOSE -f docker-compose.react.yml up -d --force-recreate || { echo "❌ Start failed"; exit 1; }
              
              echo "Waiting for services to start..."
              sleep 10
              # Wait for services to be ready
              echo "Waiting for services to be healthy..."
              wait_for_service docker-compose.react.yml frontend || { echo "❌ Frontend service failed"; $DOCKER_COMPOSE -f docker-compose.react.yml logs frontend; exit 1; }
              wait_for_service docker-compose.react.yml web || { echo "❌ Web service failed"; $DOCKER_COMPOSE -f docker-compose.react.yml logs web; exit 1; }
              wait_for_service docker-compose.react.yml nginx || { echo "❌ Nginx service failed"; $DOCKER_COMPOSE -f docker-compose.react.yml logs nginx; exit 1; }
              
              # Wait for database to be ready
              echo "Waiting for database..."
              $DOCKER_COMPOSE -f docker-compose.react.yml exec -T web python manage.py check --database default || { echo "⚠️ Database check failed, waiting 5s..."; sleep 5; }
              $DOCKER_COMPOSE -f docker-compose.react.yml exec -T web python manage.py migrate --noinput || { echo "❌ Migration failed"; $DOCKER_COMPOSE -f docker-compose.react.yml logs web; exit 1; }
              $DOCKER_COMPOSE -f docker-compose.react.yml exec -T web python manage.py collectstatic --noinput || { echo "❌ Collectstatic failed"; exit 1; }
              
              # Verify services are working
              echo "Verifying frontend is serving React..."
              verify_frontend || { echo "❌ Frontend verification failed"; $DOCKER_COMPOSE -f docker-compose.react.yml logs frontend; exit 1; }
              
              echo "Verifying API is responding..."
              verify_api || { echo "❌ API verification failed"; $DOCKER_COMPOSE -f docker-compose.react.yml logs web; exit 1; }
              
              # Verify deployment
              $DOCKER_COMPOSE -f docker-compose.react.yml ps
            else
              # Clean restart to prevent container state issues
              echo "Stopping existing containers..."
              $DOCKER_COMPOSE -f docker-compose.prod.yml down || echo "No containers to stop"
              
              echo "Building containers..."
              $DOCKER_COMPOSE -f docker-compose.prod.yml build || { echo "❌ Build failed"; exit 1; }
              
              echo "Starting containers..."
              $DOCKER_COMPOSE -f docker-compose.prod.yml up -d --force-recreate || { echo "❌ Start failed"; exit 1; }
              
              echo "Waiting for services to start..."
              sleep 10
              
              # Wait for services to be ready
              echo "Waiting for services to be healthy..."
              wait_for_service docker-compose.prod.yml web || { echo "❌ Web service failed"; $DOCKER_COMPOSE -f docker-compose.prod.yml logs web; exit 1; }
              wait_for_service docker-compose.prod.yml nginx || { echo "❌ Nginx service failed"; $DOCKER_COMPOSE -f docker-compose.prod.yml logs nginx; exit 1; }
              
              # Wait for database to be ready
              echo "Waiting for database..."
              $DOCKER_COMPOSE -f docker-compose.prod.yml exec -T web python manage.py check --database default || { echo "⚠️ Database check failed, waiting 5s..."; sleep 5; }
              $DOCKER_COMPOSE -f docker-compose.prod.yml exec -T web python manage.py migrate --noinput || { echo "❌ Migration failed"; $DOCKER_COMPOSE -f docker-compose.prod.yml logs web; exit 1; }
              $DOCKER_COMPOSE -f docker-compose.prod.yml exec -T web python manage.py collectstatic --noinput || { echo "❌ Collectstatic failed"; exit 1; }
              
              # Verify API is responding
              echo "Verifying API is responding..."
              verify_api || { echo "❌ API verification failed"; $DOCKER_COMPOSE -f docker-compose.prod.yml logs web; exit 1; }
              
              # Verify deployment
              $DOCKER_COMPOSE -f docker-compose.prod.yml ps
            fi
            
            echo "✅ Deployment complete!"
