---
import Layout from '../../layouts/Layout.astro';
import { StationPageContent } from '../../components/StationPageContent';
import { fetchStation, fetchStationShows } from '../../api/client';
import type { Show, Station } from '../../types';

const { stationId } = Astro.params;

if (!stationId) {
  return Astro.redirect('/404');
}

// Fetch data
let station: Station | null = null;
let shows: Show[] = [];

try {
  const [stationData, showsData] = await Promise.all([
    fetchStation(stationId).catch(() => null),
    fetchStationShows(stationId).catch(() => [])
  ]);

  station = Array.isArray(stationData) ? stationData[0] : stationData;
  shows = Array.isArray(showsData) 
    ? showsData 
    : showsData.results || [];
} catch (error) {
  console.error('Error fetching station data:', error);
}

if (!station) {
  return Astro.redirect('/404');
}

const pageTitle = `${station.name} â€” Radio Reads`;
const pageDescription = station.description
  ? station.description.slice(0, 155) + (station.description.length > 155 ? '...' : '')
  : `Books discussed on ${station.name} radio programmes. Browse shows and book recommendations.`;
---

<Layout
  title={pageTitle}
  description={pageDescription}
  pathname={Astro.url.pathname}
>
  <StationPageContent station={station} shows={shows} client:load />
</Layout>

