---
import Layout from '../../layouts/Layout.astro';
import { ShowPageContent } from '../../components/ShowPageContent';
import { fetchShow, fetchShowBooks } from '../../api/client';

const { showSlug } = Astro.params;

if (!showSlug) {
  return Astro.redirect('/404');
}

// Get query params
const page = parseInt(Astro.url.searchParams.get('page') || '1', 10);
const booksPerPage = 10;

// Fetch data by slug
let show;
let books = { results: [], count: 0 };

try {
  const [showData, booksData] = await Promise.all([
    fetchShow(showSlug),
    fetchShowBooks(showSlug, page, booksPerPage).catch(() => ({ results: [], count: 0 }))
  ]);
  show = showData;
  books = booksData;
} catch (error) {
  console.error('Error fetching show data:', error);
  return Astro.redirect('/404');
}

if (!show) {
  return Astro.redirect('/404');
}

const stationName = show.station?.name || '';
const pageTitle = `${show.name} â€” Books from ${stationName} | Radio Reads`;
const pageDescription = show.description
  ? show.description.slice(0, 155) + (show.description.length > 155 ? '...' : '')
  : `Books discussed and recommended on ${show.name} (${stationName}). ${show.book_count} books and counting.`;
---

<Layout
  title={pageTitle}
  description={pageDescription}
  pathname={Astro.url.pathname}
>
  <ShowPageContent
    initialShow={show}
    initialBooks={books}
    initialPage={page}
    client:load
  />
</Layout>
