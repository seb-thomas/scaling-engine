---
import Layout from '../../layouts/Layout.astro';
import { ShowPageContent } from '../../components/ShowPageContent';
import { fetchShow, fetchShowBooks } from '../../api/client';

const { showId } = Astro.params;

if (!showId) {
  return Astro.redirect('/404');
}

const showIdNum = Number(showId);
if (!showIdNum) {
  return Astro.redirect('/404');
}

// Get query params
const page = parseInt(Astro.url.searchParams.get('page') || '1', 10);
const booksPerPage = 10;

// Fetch data
let show;
let books = { results: [], count: 0 };

try {
  const [showData, booksData] = await Promise.all([
    fetchShow(showIdNum),
    fetchShowBooks(showIdNum, page, booksPerPage).catch(() => ({ results: [], count: 0 }))
  ]);
  show = showData;
  books = booksData;
} catch (error) {
  console.error('Error fetching show data:', error);
  return Astro.redirect('/404');
}

if (!show) {
  return Astro.redirect('/404');
}
---

<Layout pathname={Astro.url.pathname}>
  <ShowPageContent 
    initialShow={show} 
    initialBooks={books} 
    initialPage={page}
    client:load 
  />
</Layout>

