---
import Layout from '../../layouts/Layout.astro';
import { TopicPageContent } from '../../components/TopicPageContent';
import { fetchTopic, fetchTopicBooks } from '../../api/client';

const { topicSlug } = Astro.params;

if (!topicSlug) {
  return Astro.redirect('/404');
}

const page = parseInt(Astro.url.searchParams.get('page') || '1', 10);
const booksPerPage = 10;

let topic;
let books = { results: [], count: 0 };

try {
  const [topicData, booksData] = await Promise.all([
    fetchTopic(topicSlug),
    fetchTopicBooks(topicSlug, page, booksPerPage).catch(() => ({ results: [], count: 0 })),
  ]);
  topic = topicData;
  books = booksData;
} catch (error) {
  console.error('Error fetching topic data:', error);
  return Astro.redirect('/404');
}

if (!topic) {
  return Astro.redirect('/404');
}

const pageTitle = `${topic.name} Books â€” Radio Reads`;
const pageDescription = topic.description
  ? topic.description.slice(0, 155) + (topic.description.length > 155 ? '...' : '')
  : `${topic.name} books discussed on BBC Radio 4 and NPR. ${topic.book_count} books in this topic.`;
---

<Layout
  title={pageTitle}
  description={pageDescription}
  pathname={Astro.url.pathname}
>
  <TopicPageContent
    initialTopic={topic}
    initialBooks={books}
    initialPage={page}
    client:load
  />
</Layout>
