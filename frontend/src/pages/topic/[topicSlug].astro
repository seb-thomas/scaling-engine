---
import Layout from '../../layouts/Layout.astro';
import { TopicPageContent } from '../../components/TopicPageContent';
import { fetchTopic, fetchTopicBooks } from '../../api/client';

const { topicSlug } = Astro.params;

if (!topicSlug) {
  return Astro.redirect('/404');
}

const page = parseInt(Astro.url.searchParams.get('page') || '1', 10);
const booksPerPage = 10;

let topic;
let books = { results: [], count: 0 };

try {
  const [topicData, booksData] = await Promise.all([
    fetchTopic(topicSlug),
    fetchTopicBooks(topicSlug, page, booksPerPage).catch(() => ({ results: [], count: 0 })),
  ]);
  topic = topicData;
  books = booksData;
} catch (error) {
  console.error('Error fetching topic data:', error);
  return Astro.redirect('/404');
}

if (!topic) {
  return Astro.redirect('/404');
}
---

<Layout pathname={Astro.url.pathname}>
  <TopicPageContent
    initialTopic={topic}
    initialBooks={books}
    initialPage={page}
    client:load
  />
</Layout>
