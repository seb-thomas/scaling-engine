---
import Layout from '../../layouts/Layout.astro';
import { BookDetailPageContent } from '../../components/BookDetailPageContent';
import { fetchBook } from '../../api/client';

const { showSlug, bookSlug } = Astro.params;

if (!showSlug || !bookSlug) {
  return Astro.redirect('/404');
}

// Fetch book by slug
let book;
try {
  book = await fetchBook(bookSlug);
} catch (error) {
  console.error('Error fetching book:', error);
  return Astro.redirect('/404');
}

if (!book) {
  return Astro.redirect('/404');
}

// Verify the book belongs to the correct show (by slug)
const primaryBrandSlug = book.episodes?.[0]?.brand?.slug;
if (primaryBrandSlug !== showSlug) {
  // Redirect to correct URL if show slug doesn't match
  return Astro.redirect(`/${primaryBrandSlug ?? 'unknown'}/${book.slug}`);
}

const brandName = book.episodes?.[0]?.brand?.name || '';
const pageTitle = `${book.title} by ${book.author || 'Unknown'} â€” Radio Reads`;
const pageDescription = book.description
  ? book.description.slice(0, 155) + (book.description.length > 155 ? '...' : '')
  : `${book.title} by ${book.author || 'Unknown'}, discussed on ${brandName}. Find out more about this book on Radio Reads.`;
const pageImage = book.cover_image || undefined;
---

<Layout
  title={pageTitle}
  description={pageDescription}
  ogType="book"
  ogImage={pageImage}
  pathname={Astro.url.pathname}
>
  <BookDetailPageContent book={book} showSlug={showSlug} client:load />
</Layout>
